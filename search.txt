Search and indexing configuration
=================================

How Indexing works
------------------

Indexing is not driven by the user, but happens automatically in the
background and can be controlled by the settings listed under
:ref:`search_configuration`. The indexer runs periodically as defined
by :term:omero.search.cron and parses the latest batch of new or
modified objects in the database.

Upon successful completion, the persistent count in the ``configuration``
table will be incremented.

::

    omero=# select value from configuration where name = 'PersistentEventLogLoader.v2.current_id';
     value
    -------
     30983
    (1 row)

.. note::

   If you have more than one ``PersistentEventLogLoader.*`` value in your
   database, then you have run indexing with multiple versions of the
   server. This is fine. To allow a new server version to force an update,
   the configuration key may be changed. For example,
   ``PersistentEventLogLoader.current_id`` became
   ``PersistentEventLogLoader.v2.current_id`` in :commit:`a5cb64a`.

.. _search-reindexing:

Re-indexing
-----------

There are a few reasons that you may need to re-index your database. The
following list is non-exhaustive:

- You have upgraded from a server prior to 5.0.1 and you have experienced
  issues with search in the past, re-indexing is highly recommended.
- Searching does not return the expected results (see
  :ref:`troubleshooting-search`).
- You would like to add large files that were previously skipped to the
  index (see :term:`omero.search.max_file_size`).

Background re-indexing
^^^^^^^^^^^^^^^^^^^^^^

Under most circumstances, you should be able to re-index the database while
the server is still running. If you need to make any adjustments to the server
configuration or the process heap size, first shut the server down and make
these changes before restarting the server. Use the following steps to
initiate a re-indexing.

-  Disable the search indexer process and stop any currently running indexer
   processes:

   ::

       $ bin/omero admin reindex --prepare

-  Remove the existing search Indexes by deleting the contents of the
   :file:`FullText` subdirectory of your ${omero.data.dir}:

   ::

       $ bin/omero admin reindex --wipe

-  Reset the indexer's progress counter in the database:

   ::

       $ bin/omero admin reindex --reset 0

-  Re-enable/restart the indexer process:

   ::

       $ bin/omero admin reindex --finish

Depending on the size of your database, it may take the indexer some time to
finish re-indexing. During this time, your OMERO server will remain available
for use, however the search functionality will be degraded until the
re-indexing is finished.

Off-line re-indexing
^^^^^^^^^^^^^^^^^^^^

It is also possible to re-index the database with the server off-line. First,
shutdown the OMERO server as normal and make any adjustments to the
configuration that need to be made. Clear the contents of the :file:`FullText`
directory as above, then run

::

   $ bin/omero admin reindex --foreground

Re-indexing the database in off-line mode will use a 1 GB heap by default, but
this can be specified on the command-line `--mem`:

::

   $ bin/omero admin reindex --foreground --mem=2g

Other search configuration properties from :ref:`search_configuration` can be
set for the processing by setting the "JAVA_OPTS" environment variable:

::

   $ JAVA_OPTS=-Domero.search.max_partition_size=100000"" bin/omero admin reindex --foreground

Once forground indexing is complete, re-enable the background indexer as above:

   ::

       $ bin/omero admin reindex --finish

Monitoring re-indexing
^^^^^^^^^^^^^^^^^^^^^^

During re-indexing, it is possible to estimate the percent indexed using the
following SQL command::


    omero=> select 'At ' ||  current_timestamp(0) || ', Percent indexed: ' || trunc(((select count(*) from eventlog el, configuration c where el.id < cast(c.value as int) and (c.name like 'PersistentEventLogLoader%')) * 1.0) / (select count(*) from eventlog) * 100, 2) || '%';
                      ?column?
    ----------------------------------------------------
     At 2014-06-14 07:54:37+00, Percent indexed: 70.90%
    (1 row)

The overall re-indexing performance depends significantly on the memory
settings and the size of the repository to index. The following table provides
estimates of the process duration based on re-indexing of existing production
servers of various sizes:

.. list-table::
  :header-rows: 1

  - * Re-indexing type
    * Re-indexing duration
    * Binary repository size
    * Indexer JVM settings
    * omero.search.batch

  - * Background
    * 31h
    * 300GB
    * -Xmx512M
    * 50

  - * Background
    * 10 days
    * 16TB
    * -Xmx2048M
    * 100

.. seealso::
  :doc:`/developers/Modules/Search`
    Section of the developer documentation describing how to perform search
    queries against the server.
